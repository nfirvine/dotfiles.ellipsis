#!/usr/bin/env node
// Wrapper around cake that will use shortcake if it's installed, otherwise
// swap arguments around so tasks are always last.
var path            = require('path'),
    cakeModule      = 'coffee-script/lib/coffee-script/cake',
    shortcakeModule = 'shortcake/lib/cli';

// Look in all the usual places for our module.
function findModule(modPath) {
  try {
    return require.resolve(modPath);
  } catch (err) {
    modPath = path.join('/usr/local/lib/node_modules', modPath)
  }

  // Then look in /usr/lib
  try {
    return require.resolve(modPath);
  } catch (err) {
    modPath = modPath.replace('/usr/local/lib', '/usr/lib')
  }

  return require.resolve(modPath)
}

// Process args with cake.
function cake() {
  try {
    require(findModule(cakeModule)).run()
  } catch (err) {
    if (/Cakefile not found in/.test(err.message))
      console.log(err.message)
    else
      throw err
  }
}

// Process args with shortcake.
function shortcake() {
  require(findModule(shortcakeModule))
}

// Try to use shortcake, if that fails use cake.
try {
  shortcake()
} catch (err) {
  console.log('warning: Unable to find shortcake, falling back to cake.')
  cake()
}

// vim: ft=javascript:
